{% load static %}

<link rel="stylesheet" href="{% static 'restaurant/style.css' %}">

<div class="menu-container">
    <h1 class="page-title">Manage Menu</h1>

    <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± -->
    <button class="add-item-btn" onclick="toggleAddForm()">+ Add New Item</button>

    <!-- ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
    <div id="add-form" class="add-form hidden">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="add_item" value="1">
            {{ form.as_p }}
            <button class="add-submit-btn">Add Item</button>
        </form>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± -->
    <div class="menu-grid">
        {% for item in menu_items %}
        <div class="menu-card">

            <!-- Ø§Ù„ØµÙˆØ±Ø© + Ø§Ù„Ù†Øµ -->
            <div class="menu-main">
                {% if item.image %}
                    <img src="{{ item.image.url }}" class="menu-image">
                {% else %}
                    <div class="menu-image placeholder"></div>
                {% endif %}

                <div class="menu-info">
                    <h3 class="menu-name">{{ item.name }}</h3>
                    <p class="menu-desc">{{ item.description }}</p>
                    <p class="menu-price">Price: {{ item.price }} SAR</p>
                    <p class="menu-category">Category: {{ item.get_category_display }}</p>

                    <p class="menu-status">
                        Status:
                        {% if item.is_available %}
                            <span class="status available">Available</span>
                        {% else %}
                            <span class="status unavailable">Unavailable</span>
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="menu-actions">
                <button onclick="openEditModal({{ item.id }})" class="btn-small btn-edit">âœ Edit</button>

                <a href="{% url 'delete_menu_item' item.id %}" 
                   class="delete-btn"
                   onclick="return confirm('Are you sure you want to delete this item?');">
                   ğŸ—‘ Delete
                </a>

                <a href="{% url 'toggle_availability' item.id %}" class="btn-small btn-toggle">âŸ³ Toggle</a>
            </div>

        </div>
        {% empty %}
        <p class="empty-msg">No menu items added yet.</p>
        {% endfor %}
    </div>
</div>


<!-- â­â­â­ Modal (Edit Item) â­â­â­ -->
<div id="editModal" class="modal hidden">
    <div class="modal-content">

        <h2 class="modal-title">Edit Item</h2>

        <form id="editForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Django -->
            <div id="editFormFields"></div>

            <!-- ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø· -->
            <div id="currentImagePreview"></div>

            <!-- ğŸ”¥ Is available -->
            <div class="available-row">
                <label for="id_is_available">Is available:</label>
                <input type="checkbox" id="id_is_available" name="is_available">
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± -->
            <div class="modal-actions">
                <button type="submit" class="btn-save">Save</button>
                <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
            </div>

        </form>

    </div>
</div>


<!-- JavaScript -->
<script>

function toggleAddForm() {
    document.getElementById("add-form").classList.toggle("hidden");
}

/* â­ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
function openEditModal(itemId) {
    fetch(`/manager/menu/edit/${itemId}/`)
        .then(response => response.text())
        .then(html => {

            // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            document.getElementById("editFormFields").innerHTML = html;

            // ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ø³Ø·Ø± Clear Ù…Ù† Ø§Ù„ÙÙˆØ±Ù…
            document.querySelectorAll("label").forEach(label => {
                if (label.innerText.trim() === "Clear") {
                    label.parentElement.style.display = "none";
                }
            });

            // ğŸ”¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙÙ‚Ø·
            const imgMatch = html.match(/src="([^"]+)"/);
            if (imgMatch) {
                document.getElementById("currentImagePreview").innerHTML =
                    `<p><strong>Current Image:</strong></p>
                     <img src="${imgMatch[1]}" class="image-preview">`;
            } else {
                document.getElementById("currentImagePreview").innerHTML = "";
            }

            // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„ÙÙˆØ±Ù…
            document.getElementById("editForm").action = `/manager/menu/edit/${itemId}/`;

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            document.getElementById("editModal").classList.remove("hidden");
        });
}

/* â­ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
function closeModal() {
    document.getElementById("editModal").classList.add("hidden");
}

</script>


